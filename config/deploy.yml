# Kamal 2 deployment configuration for CastMe
# Documentation: https://kamal-deploy.org/docs/configuration/overview/

service: castme

# Docker image name - registry server is prepended automatically
image: castme

# Servers configuration
servers:
  web:
    hosts:
      - <%= ENV['DEPLOY_HOST'] %>
    options:
      # SQLite database volume (separate from /rails/db to preserve Schemafile from image)
      volume:
        - castme_data:/rails/data
        - castme_storage:/rails/storage

# Kamal 2 proxy configuration
proxy:
  ssl: true
  host: <%= ENV['DEPLOY_DOMAIN'] %>
  app_port: 3000
  healthcheck:
    path: /up
    interval: 10
    timeout: 5

# AWS ECR registry
registry:
  server: <%= ENV['AWS_ACCOUNT_ID'] %>.dkr.ecr.us-west-2.amazonaws.com
  username: AWS
  password:
    - KAMAL_REGISTRY_PASSWORD

# SSH configuration
ssh:
  user: ubuntu

# Builder configuration
builder:
  arch: amd64
  local: true
  # Use remote builder if building on Apple Silicon
  # remote:
  #   arch: amd64
  #   host: ssh://ubuntu@<build-server-ip>

# Environment variables
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: "1"
    RAILS_SERVE_STATIC_FILES: "true"
  secret:
    - RAILS_MASTER_KEY
    - SECRET_KEY_BASE
    - ONESIGNAL_APP_ID
    - ONESIGNAL_API_KEY

# Asset bridging for zero-downtime deployments
asset_path: /rails/public/assets
