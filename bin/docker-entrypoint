#!/bin/bash
set -e

# Fix ownership of mounted volumes only if needed (runs as root)
if [ ! -w /rails/data ]; then
  echo "Fixing volume permissions..."
  chown -R rails:rails /rails/data /rails/storage /rails/log /rails/tmp 2>/dev/null || true
fi

# Apply database schema with ridgepole (as rails user)
echo "Applying database schema with ridgepole..."
gosu rails bundle exec ridgepole -c config/database.yml -E production -f db/Schemafile -a

# Execute the main command as rails user
exec gosu rails "$@"
