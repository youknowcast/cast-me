#!/bin/bash
set -e

# Fix ownership of mounted volumes (runs as root)
# Always run this to ensure volumes have correct permissions
echo "Ensuring volume permissions..."
chown -R rails:rails /rails/data /rails/storage /rails/log /rails/tmp 2>/dev/null || true

# Apply database schema with ridgepole (as rails user)
echo "Applying database schema with ridgepole..."
gosu rails bundle exec ridgepole -c config/database.yml -E production -f db/Schemafile -a -r /app/config/ridgepole.rb

# Execute the main command as rails user
exec gosu rails "$@"
